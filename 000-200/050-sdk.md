# 050: Production-Ready TypeScript SDK Release âœ… COMPLETED

**Status**: âœ… COMPLETED (2025-08-14)
**Implementation**: See `packages/ameide_sdk_ts` and `packages/ameide_core_proto_web`

## Overview

Transform the existing TypeScript SDK (`packages/ameide_core-sdk-ts`) into a production-ready, published package with proper proto generation pipeline, high-level client wrapper, comprehensive documentation, and automated release process.

## Current State

**âœ… COMPLETED FEATURES:**

The SDK now has:
- âœ… Connect-ES transport with auth interceptors
- âœ… OAuth2Provider with automatic token refresh
- âœ… Sophisticated retry logic with sleeper injection
- âœ… Error handling and type safety
- âœ… Tree-shakeable exports via tsup
- âœ… < 50KB bundle size (achieved via thin wrapper)
- âœ… Buf-powered proto generation pipeline
- âœ… High-level `AmeideClient` wrapper
- âœ… Comprehensive README documentation
- âœ… Mock transport with examples
- âœ… Bazel build integration

**Deferred to future work:**
- â¸ï¸ TypeDoc API documentation generation
- â¸ï¸ Automated GitHub releases
- â¸ï¸ NPM publishing pipeline automation
- â¸ï¸ Bundle size CI checks

## Implementation Plan

### Week 1: Buf Configuration & Generation Pipeline

**Day 1-2: Setup Buf Workspace**
```yaml
# buf.yaml
version: v1
name: buf.build/ameide/platform
breaking:
  use:
    - FILE
lint:
  use:
    - DEFAULT

# buf.gen.yaml (v2)
version: v2
clean: true
plugins:
  - remote: buf.build/bufbuild/es:v2.7.0
    out: packages/ameide_core-sdk-ts/src/generated
    include_imports: true
    opt:
      - target=ts
      - import_extension=js
```

**Day 3-4: Generation Scripts**
```json
// package.json additions
{
  "scripts": {
    "generate": "buf generate --template buf.gen.yaml",
    "generate:check": "buf generate --template buf.gen.yaml && git diff --exit-code"
  }
}
```

**Day 5: Clean Generated Code**
- Remove old generated files from git
- Add to `.gitignore`: `src/generated/**`
- Update `.eslintignore` and `.prettierignore`
- Add generation to CI pipeline

### Week 2: High-Level Client Wrapper

**Day 1-2: AmeideClient Implementation**
```typescript
// src/client/AmeideClient.ts
import { createClient, type Transport, type Client } from '@connectrpc/connect';
import { createConnectTransport } from '@connectrpc/connect-web';
import type { AuthProvider } from '../auth/types';

// Import generated service descriptors (now in *_pb)
import { UserService } from '../generated/ameide/platform/v1/users_pb';
import { WorkflowService } from '../generated/ameide/ipa/v1/workflows_pb';
import { AgentService } from '../generated/ameide/ipa/v1/agents_pb';
import { IPAService } from '../generated/ameide/ipa/v1/ipas_pb';

export interface AmeideConfig {
  baseUrl: string;
  auth: AuthProvider | AuthConfig;
  retry?: RetryConfig;
  timeout?: number;
  headers?: Record<string, string>;
}

export class AmeideClient {
  private transport: Transport;
  
  // Service clients as public readonly properties for tree-shaking
  readonly users: Client<typeof UserService>;
  readonly workflows: Client<typeof WorkflowService>;
  readonly agents: Client<typeof AgentService>;
  readonly ipas: Client<typeof IPAService>;

  constructor(config: AmeideConfig) {
    this.transport = createConnectTransport({
      baseUrl: config.baseUrl,
      interceptors: [],
    });

    // Initialize service clients
    this.users = createClient(UserService, this.transport);
    this.workflows = createClient(WorkflowService, this.transport);
    this.agents = createClient(AgentService, this.transport);
    this.ipas = createClient(IPAService, this.transport);
  }

  // Convenience methods
  async getCurrentUser() {
    return this.users.getCurrentUser({});
  }

  async executeWorkflow(workflowsId: string, inputs: Record<string, any>) {
    return this.workflows.executeWorkflow({
      workflowsId,
      inputs: JSON.stringify(inputs),
    });
  }

  // Streaming example
  async *streamWorkflowLogs(executionId: string) {
    const stream = this.workflows.streamExecutionLogs({ executionId });
    for await (const log of stream) {
      yield log;
    }
  }
}
```

**Day 3-4: Integration Tests**
```typescript
// src/client/__tests__/AmeideClient.test.ts
import { AmeideClient } from '../AmeideClient';
import { ApiKeyProvider } from '../../auth/ApiKeyProvider';

describe('AmeideClient', () => {
  it('should initialize with API key auth', () => {
    const client = new AmeideClient({
      baseUrl: 'https://api.ameide.io',
      auth: new ApiKeyProvider({ apiKey: 'test-key' }),
    });

    expect(client.users).toBeDefined();
    expect(client.workflows).toBeDefined();
  });

  it('should handle OAuth2 auth config', () => {
    const client = new AmeideClient({
      baseUrl: 'https://api.ameide.io',
      auth: {
        type: 'oauth2',
        clientId: 'test-client',
        clientSecret: 'test-secret',
        tokenEndpoint: 'https://auth.ameide.io/token',
      },
    });

    expect(client).toBeDefined();
  });
});
```

**Day 5: Export Updates**
```typescript
// src/index.ts
export { AmeideClient } from './client/AmeideClient';
export type { AmeideConfig } from './client/AmeideClient';

// Re-export useful types from generated code
export type { User, Role } from './generated/ameide/platform/v1/users_pb';
export type { Workflow, WorkflowExecution } from './generated/ameide/ipa/v1/workflows_pb';
```

### Week 3: Documentation & Examples

**Day 1-2: TypeDoc Setup**
```json
// typedoc.json
{
  "$schema": "https://typedoc.org/schema.json",
  "entryPoints": ["src/index.ts"],
  "out": "docs/api",
  "plugin": ["typedoc-plugin-markdown"],
  "excludePrivate": true,
  "excludeProtected": true,
  "excludeInternal": true,
  "categorizeByGroup": true,
  "navigation": {
    "includeCategories": true,
    "includeGroups": true
  },
  "visibilityFilters": {
    "protected": false,
    "private": false,
    "inherited": true,
    "external": false
  }
}
```

**Day 3: Examples Directory**
```typescript
// examples/node/basic-usage.ts
import { AmeideClient } from '@ameide/sdk';

async function main() {
  const client = new AmeideClient({
    baseUrl: process.env.AMEIDE_API_URL || 'https://api.ameide.io',
    auth: {
      type: 'apiKey',
      apiKey: process.env.AMEIDE_API_KEY!,
    },
  });

  // Get current user
  const user = await client.getCurrentUser();
  console.log('Current user:', user.name);

  // List workflows
  const workflows = await client.workflows.listWorkflows({
    pageSize: 10,
  });
  
  for (const workflows of workflows.workflows) {
    console.log(`- ${workflows.name} (${workflows.id})`);
  }
}

main().catch(console.error);
```

```typescript
// examples/browser/react-hook.tsx
import { useEffect, useState } from 'react';
import { AmeideClient, OAuth2Provider } from '@ameide/sdk';

const authProvider = new OAuth2Provider({
  clientId: process.env.REACT_APP_CLIENT_ID!,
  redirectUri: window.location.origin + '/callback',
  authorizationEndpoint: 'https://auth.ameide.io/authorize',
  tokenEndpoint: 'https://auth.ameide.io/token',
});

const client = new AmeideClient({
  baseUrl: 'https://api.ameide.io',
  auth: authProvider,
});

export function useCurrentUser() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    client.getCurrentUser()
      .then(setUser)
      .catch(setError)
      .finally(() => setLoading(false));
  }, []);

  return { user, loading, error };
}
```

**Day 4-5: Getting Started Guide**
```markdown
# Getting Started

## Installation

```bash
npm install @ameide/sdk
# or
yarn add @ameide/sdk
# or
pnpm add @ameide/sdk
```

## Quick Start

### API Key Authentication

```typescript
import { AmeideClient } from '@ameide/sdk';

const client = new AmeideClient({
  baseUrl: 'https://api.ameide.io',
  auth: {
    type: 'apiKey',
    apiKey: 'your-api-key',
  },
});

// Get current user
const user = await client.getCurrentUser();
```

### OAuth2 Authentication

```typescript
import { AmeideClient, OAuth2Provider } from '@ameide/sdk';

const auth = new OAuth2Provider({
  clientId: 'your-client-id',
  clientSecret: 'your-client-secret',
  tokenEndpoint: 'https://auth.ameide.io/token',
});

const client = new AmeideClient({
  baseUrl: 'https://api.ameide.io',
  auth,
});
```

### Streaming

```typescript
// Stream workflows execution logs
const stream = client.streamWorkflowLogs('execution-id');

for await (const log of stream) {
  console.log(`[${log.timestamp}] ${log.message}`);
}
```
```

### Week 4: Bundle Size & CI

**Day 1-2: Size Limit Setup**
```json
// package.json
{
  "size-limit": [
    {
      "path": "dist/index.js",
      "limit": "50 KB"
    },
    {
      "path": "dist/index.mjs",
      "limit": "45 KB"
    }
  ],
  "scripts": {
    "size": "size-limit",
    "analyze": "size-limit --why"
  }
}
```

**Day 3-4: GitHub Actions**
```yaml
# .github/workflows/sdk-ci.yml
name: SDK CI

on:
  push:
    branches: [main]
  pull_request:
    paths:
      - 'packages/ameide_core-sdk-ts/**'
      - 'proto/**'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
        
      - name: Generate proto
        run: pnpm generate
        working-directory: packages/ameide_core-sdk-ts
        
      - name: Type check
        run: pnpm type-check
        working-directory: packages/ameide_core-sdk-ts
        
      - name: Lint
        run: pnpm lint
        working-directory: packages/ameide_core-sdk-ts
        
      - name: Test
        run: pnpm test --coverage
        working-directory: packages/ameide_core-sdk-ts
        
      - name: Build
        run: pnpm build
        working-directory: packages/ameide_core-sdk-ts
        
      - name: Check bundle size
        run: pnpm size
        working-directory: packages/ameide_core-sdk-ts
```

**Day 5: Release Automation**
```yaml
# .github/workflows/sdk-release.yml
name: SDK Release

on:
  push:
    tags:
      - 'sdk-v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
        
      - name: Build SDK
        run: |
          pnpm generate
          pnpm build
        working-directory: packages/ameide_core-sdk-ts
        
      - name: Publish to NPM
        run: npm publish --access public
        working-directory: packages/ameide_core-sdk-ts
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: packages/ameide_core-sdk-ts/dist/*
          generate_release_notes: true
```

### Week 5: Documentation Site & Beta Release

**Day 1-2: Documentation Site**
```yaml
# .github/workflows/docs.yml
name: Deploy Docs

on:
  push:
    branches: [main]
    paths:
      - 'packages/ameide_core-sdk-ts/**'
      - 'docs/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
        
      - name: Generate API docs
        run: pnpm docs
        working-directory: packages/ameide_core-sdk-ts
        
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./packages/ameide_core-sdk-ts/docs
```

**Day 3-4: Beta Release Checklist**
- [ ] All tests passing with >80% coverage
- [ ] Bundle size <50KB gzipped
- [ ] TypeDoc generates without warnings
- [ ] Examples run without errors
- [ ] README has quick start guide
- [ ] CHANGELOG.md created
- [ ] Security policy documented
- [ ] License file included

**Day 5: Announce Beta**
```markdown
# @ameide/sdk v0.1.0-beta

We're excited to announce the beta release of the Ameide TypeScript SDK!

## Features
- ðŸš€ Full TypeScript support with generated types
- ðŸ” Built-in OAuth2 and API key authentication
- ðŸ”„ Automatic retry with exponential backoff
- ðŸ“¦ Tree-shakeable - only pay for what you use
- ðŸŒ Works in Node.js and browsers
- ðŸ“¡ Streaming support via Connect protocol

## Installation
```bash
npm install @ameide/sdk@beta
```

## Links
- [Documentation](https://ameide.github.io/sdk)
- [API Reference](https://ameide.github.io/sdk/api)
- [Examples](https://github.com/ameide/sdk/tree/main/examples)
```

## Success Metrics

1. **Bundle Size**
   - Base bundle <50KB gzipped âœ“
   - Individual service imports <15KB each
   - Zero runtime dependencies beyond Connect

2. **Developer Experience**
   - Time to first API call <5 minutes
   - 100% TypeScript coverage
   - IntelliSense for all methods
   - Clear error messages with codes

3. **Quality**
   - >90% test coverage
   - 0 TypeScript errors in strict mode
   - All examples run in CI
   - Generated code excluded from coverage

4. **Performance**
   - SDK initialization <10ms
   - Auth token caching works
   - Retry delays use high-precision timers

## Technical Decisions

### Proto Generation
- **buf + connect-es**: Best DX, official Connect support
- **No manual edits**: Generated code is ephemeral
- **Import style**: ES modules only for smaller bundles

### Client Architecture
- **No DI container**: Simple property access for tree-shaking
- **Service segregation**: Each service is a separate import path
- **Streaming-first**: All list operations return async iterables

### Publishing Strategy
- **NPM only**: No need for separate CDN (unpkg/jsdelivr auto-host)
- **Dual build**: ESM primary, CJS for legacy Node.js
- **Types included**: .d.ts files ship with the package

## Dependencies

This SDK release depends on:
- Stable proto definitions (blocked on backlog items)
- Working API endpoints with CORS configured
- OAuth2 authorization server running
- API documentation for examples

## Future Enhancements

1. **Framework packages**
   - `@ameide/sdk-react` - React hooks
   - `@ameide/sdk-vue` - Vue composables
   - `@ameide/sdk-angular` - Angular services

2. **Advanced features**
   - Offline queue with IndexedDB
   - Request deduplication
   - Optimistic updates
   - WebSocket subscriptions

3. **Developer tools**
   - VS Code extension for proto IntelliSense
   - Chrome DevTools panel
   - Mock server generator
   - SDK playground

## Risk Mitigation

1. **Breaking changes**: Follow proto major = SDK major version
2. **Bundle bloat**: CI check on every PR
3. **Runtime errors**: Comprehensive error codes and messages
4. **Token expiry**: Automatic refresh with retry
5. **Network issues**: Exponential backoff with jitter

## References

- [Connect-ES Documentation](https://connectrpc.com/docs/web/getting-started)
- [Buf Schema Registry](https://buf.build/docs/bsr/introduction)
- [Size Limit](https://github.com/ai/size-limit)
- [Semantic Release](https://semantic-release.gitbook.io/)
- [TypeDoc](https://typedoc.org/)
