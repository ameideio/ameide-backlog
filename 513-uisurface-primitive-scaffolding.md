# 513 – UISurface Primitive Scaffolding (TypeScript, opinionated)

> **Status update (520/521/522):** This backlog specifies the UISurface scaffold produced by the Ameide CLI (`ameide primitive scaffold`). The consolidated approach is a split: the CLI orchestrates scaffolding + external wiring (repo layout, GitOps), and `buf generate` + plugins handle internal deterministic generation (generated-only glue and deterministic artefacts). See `backlog/520-primitives-stack-v2.md`, `backlog/521-code-generation-improvements.md`, and `backlog/522-cli-orchestration-improvements.md`.

**Status:** Active reference (aligned with 520/521/522)  
**Audience:** UI engineers, AI agents, CLI implementers  
**Scope:** Exact scaffold shape and patterns for **UISurface** primitives. One opinionated v0 pattern aligned with `520-primitives-stack-v2-tdd.md` smokes (a deterministic marker page served at `/`). No new UISurface-specific CLI parameters beyond the canonical `ameide primitive scaffold` flags.

---

## Primitive/operator alignment

- **Operator responsibilities (495, 501, 497):** The UISurface operator reconciles `UISurface` CRDs into Deployments, Services, HTTPRoutes (Gateway API), Keycloak clients, ConfigMaps, HPAs, and monitoring resources. It is responsible for how traffic reaches a UISurface and how auth/observability are wired, but it does not implement UI routes or call backend SDKs.  
- **Primitive responsibilities (this backlog, SDK_USAGE):** The UISurface scaffold owns the **application layer**: HTTP server/Connect endpoints, route handlers, and SDK-based calls into Domain/Process/Agent primitives. It lives inside the image referenced by the UISurface CRD and encapsulates UI behavior and composition, independent of operator internals.  
- **Boundary:** Operators are the **control plane for hosting and routing**; UISurface primitives are the **frontend applications** that use SDKs to talk to backends. 513’s scaffold shape is designed so the operator only needs an image and a few config fields (host/path/auth), while the primitive remains fully in charge of UX and SDK wiring, consistent with `495-ameide-operators.md`, `497-operator-implementation-patterns.md`, and `501-uisurface-operator.md`.

---

## Scope exclusion – client applications

> **Not UISurface primitives:** IDE extensions (VSCode, JetBrains), browser extensions, CLI tools, and mobile apps are **Application Components (clients)**, not UISurface primitives. They consume primitive services but are not deployed via operators, do not use `ameide primitive scaffold`, and do not live under `primitives/`. See `backlog/538-vscode-client-transformation.md` for the VSCode client pattern.

**Key distinction:**
| Aspect | UISurface Primitive | Client Application |
|--------|--------------------|--------------------|
| **Location** | `primitives/uisurface/{name}/` | `packages/{name}/` |
| **Deployment** | Operator-managed (CRD/GitOps) | Marketplace/manual install |
| **Scaffold** | `ameide primitive scaffold --kind uisurface` | Manual or extension tooling |
| **Example** | Platform dashboard, workspace UI | VSCode extension (538), CLI |

---

## General implementation guidelines (for CLI scaffolder)

- Maintain a single, opinionated scaffold per primitive kind; **do not introduce new CLI flags** beyond the existing `ameide primitive scaffold` parameters.  
- All scaffold instructions for UISurfaces must be expressed in **template files** (README/templates, comment templates), not inline string literals in the CLI codebase.  
- Generated README and code comments must be **exhaustive and self‑contained**, with **no references to external backlogs**; implementers should not need to consult design docs to understand the scaffold.  

---

## Grounding & cross‑references

- **Primitive stack:** `477-primitive-stack.md` (UISurface primitives in `primitives/uisurface/{name}`).  
- **SDK usage:** `services/www_ameide_platform/backlog/SDK_USAGE.md`.  
- **CLI overview & scaffold:** `484-ameide-cli-overview.md`, `484a-ameide-cli-primitive-workflows.md`, `484f-ameide-cli-scaffold-implementation.md`.  
- **Primitive/operator contract:** `495-ameide-operators.md`, `497-operator-implementation-patterns.md`.  
- **UISurface operator:** `501-uisurface-operator.md`.  
- **Capability implementation DAG:** `backlog/533-capability-implementation-playbook.md` (UISurface scaffold + implementation nodes).
- **Contrast – client applications:** `538-vscode-client-transformation.md`, `538-vscode-client-extension.md` (VSCode extension is NOT a UISurface primitive; see "Scope exclusion" above).

---

## 1. Canonical scaffold command (UISurface / TypeScript)

For UISurface primitives we use a minimal Node surface that serves a deterministic marker page generated by Buf (via a pinned plugin):

```bash
ameide primitive scaffold \
  --kind uisurface \
  --name <name> \
  --lang node \
  --include-gitops \
  --include-test-harness
```

This creates a UISurface primitive under:

```text
primitives/uisurface/<name>/
gitops/primitives/uisurface/<name>/
```

---

## 2. Generated structure (UISurface / Node)

```text
primitives/uisurface/<name>/
├── README.md                            # Purpose + wiring notes
├── catalog-info.yaml                    # Backstage component
├── Dockerfile                           # Production image
├── package.json                         # Node project
├── server.js                            # HTTP server (serves internal/gen/index.generated.html at `/`)
└── internal/gen/
    └── index.generated.html             # Generated by `buf generate` (via CLI-created Buf template)
```

GitOps with `--include-gitops`:

```text
gitops/primitives/uisurface/<name>/
├── values.yaml                          # UISurface Deployment/service config
├── component.yaml                       # Argo CD component descriptor
└── kustomization.yaml                   # Kustomize stub
``>

---

## 3. Opinionated v0 pattern (deterministic marker page)

Scaffolded UISurface primitives must:

- Serve a deterministic marker page at `/` (used by GitOps smoke tests).
- Keep generated artefacts under `internal/gen/**` and treat them as Buf-owned.
- Avoid coupling the runtime to the proto module; UISurface runtime is a thin web server that serves deterministic assets.

---

## 4. Verification and smoke semantics

The v0 UISurface smoke expectation is: HTTP GET `/` contains the marker string (e.g., `Hello UISurface v0`).

---

## 5. Verification expectations

`ameide primitive verify --kind uisurface --name <name>` should check:

- Presence of `src/server.ts` and `src/routes/**`.  
- `src/proto/index.ts` imports from SDK (`@ameideio/ameide-sdk-ts`), not `@ameide/core-proto`, in line with `SDK_USAGE.md`.  
- Tests exist under `tests/` and initially fail.  
- GitOps manifests are valid when present.

Behavioral details (what routes exist, what UX looks like) remain in vertical slices and UX backlogs; this document defines only the **scaffold shape and SDK usage pattern** for UISurface primitives.

---

## 6. Implementation progress (CLI & scaffold)

This section describes the current implementation status of 513 in the CLI (`packages/ameide_core_cli`) and repo scaffolds. It is descriptive; the rest of 513 remains the target spec.

### 6.1 Scaffolder behavior for UISurface primitives

**Status:** Implemented as a minimal Node UISurface that serves a generated marker page.

- `ameide primitive scaffold --kind uisurface --lang node`:
  - Creates `primitives/uisurface/<name>` with `server.js`, `package.json`, and a small `Dockerfile`.
  - Creates a per-primitive Buf template under `packages/ameide_core_proto/buf.gen.uisurface-<name>.local.yaml` that runs the static UISurface generator into `primitives/uisurface/<name>/internal/gen/`.
  - Emits `next_steps` containing a concrete `buf generate` command to produce `internal/gen/index.generated.html`.

### 6.2 SDK-only and HTTP surface behavior

**Status:** Planned in 513, but not scaffolded yet; UISurface behavior exists only as a spec.

- Runtime shape:
  - No UISurface-specific runtime code is generated today; the HTTP/Connect server + routes + SDK clients pattern exists only in this backlog.
- SDK usage:
  - There is no generated `src/proto/index.ts`, and no default wiring to `@ameideio/ameide-sdk-ts`.
  - No TS-specific import policy exists in `primitive verify` to enforce:
    - SDK-only imports,
    - Avoiding `@ameide/core-proto` in runtime code.

### 6.3 Verify behavior for UISurface primitives

**Status:** Generic checks only; UISurface-specific rules are not implemented, but the shared import policy now applies to TS runtime code.

- `primitive verify --kind uisurface --name <name>`:
  - Still runs the shared repo checks (naming, security/SAST, tests, shared `Imports` policy, optional GitOps) if a UISurface project exists.
  - Does **not** currently check:
    - Presence of `src/server.ts` or `src/routes/**`.
    - That `src/proto/index.ts` exists or uses SDK-based imports.
    - Higher-level SDK usage patterns; it only guards against obvious proto/core-proto and cross-primitive imports in TypeScript runtime code.

### 6.4 Known gaps and next steps

- Scaffold:
  - Introduce a UISurface-specific scaffold path that:
    - Generates `src/server.ts`, `src/routes/<name>.ts`, and `src/proto/index.ts`.
    - Wires SDK clients via `@ameideio/ameide-sdk-ts` in `src/proto/index.ts`.
    - Uses UISurface templates for README and code comments (similar to Domain/Agent templates).
- Verify:
  - Add TS import checks for UISurface primitives to ensure:
    - No `@ameide/core-proto` imports in runtime code.
    - SDK-only outbound calls via `@ameideio/ameide-sdk-ts` or approved barrels.
  - Shape checks for presence of server/routes/proto files.
