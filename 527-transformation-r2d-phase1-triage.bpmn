<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  xmlns:ameide="https://ameide.io/schema/bpmn/extensions/v1"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  id="Definitions_transformation_r2d_phase1_triage_v1"
                  targetNamespace="https://ameide.io/transformation/r2d/phase1/triage/v1">

  <bpmn:documentation>
    Phase 1 (Triage) â€” per Requirement.
    Purpose: produce a pinned RequirementSliceVersion (immutable refs + expectations) via an explicit Publish/DoR decision.
    Drafting/editing happens in UI (Lexical) and is versioned in Domain; it is not workflow-internal control flow.
  </bpmn:documentation>

  <bpmn:collaboration id="Collaboration_transformation_r2d_phase1_triage_v1">
    <bpmn:participant id="Participant_transformation_r2d_phase1_triage_v1"
                      name="transformation.r2d.phase1.triage.v1"
                      processRef="transformation_r2d_phase1_triage_v1"/>
  </bpmn:collaboration>

  <bpmn:process id="transformation_r2d_phase1_triage_v1"
                name="transformation.r2d.phase1.triage.v1"
                isExecutable="true">
    <bpmn:extensionElements>
      <ameide:workflowDefinition definitionId="transformation.r2d.phase1.triage.v1:527"
                                 workflowType="transformation_r2d_phase1_triage_v1"
                                 workflowIdTemplate="transformation.r2d.phase1.triage.v1/${state.tenant_id}/${state.subject_id}"/>
    </bpmn:extensionElements>

    <bpmn:startEvent id="StartEvent_publish_requested" name="Publish requested">
      <bpmn:documentation>
        Triggered when the user requests Publish/DoR for a Requirement (UI action).
        Drafting/editing happens in UI + Domain writes and is not workflow-internal control flow.
      </bpmn:documentation>
    </bpmn:startEvent>

    <bpmn:serviceTask id="Task_validate_publish_preconditions"
                      name="Validate publish preconditions">
      <bpmn:documentation>
        Deterministic validation: acceptance criteria present, repo/target set, required metadata present.
        On failure: emit evidence + mark requirement Needs Revision (handled by Domain/UI).
      </bpmn:documentation>
      <bpmn:extensionElements>
        <ameide:taskDefinition type="transformation.r2d.phase1.triage.validate_publish_preconditions.v1"
                               idempotencyKeyTemplate="r2d/${process_instance_id}/${step_id}/${step_instance_id}"
                               policyRef="default"/>
        <ameide:ioMapping>
          <ameide:output source="result.ok" target="state.publish_ok"/>
          <ameide:output source="result.reason" target="state.publish_precondition_failure_reason"/>
        </ameide:ioMapping>
      </bpmn:extensionElements>
    </bpmn:serviceTask>

    <bpmn:exclusiveGateway id="Gateway_publish_ok" name="Publish OK?"/>

    <bpmn:serviceTask id="Task_pin_slice"
                      name="Pin RequirementSliceVersion">
      <bpmn:documentation>
        Creates/pins a RequirementSliceVersion (immutable refs to markdown version + expectations + repo target).
      </bpmn:documentation>
      <bpmn:extensionElements>
        <ameide:taskDefinition type="transformation.r2d.phase1.triage.pin_slice.v1"
                               idempotencyKeyTemplate="r2d/${process_instance_id}/${step_id}/${step_instance_id}"
                               policyRef="default"/>
        <ameide:ioMapping>
          <ameide:output source="result.slice_version_id" target="state.slice_version_id"/>
        </ameide:ioMapping>
      </bpmn:extensionElements>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="Task_mark_ready_for_development"
                      name="Mark requirement Ready for Development">
      <bpmn:documentation>
        Updates requirement status to Ready for Development and links the pinned slice version.
      </bpmn:documentation>
      <bpmn:extensionElements>
        <ameide:taskDefinition type="transformation.r2d.phase1.triage.mark_ready_for_development.v1"
                               idempotencyKeyTemplate="r2d/${process_instance_id}/${step_id}/${step_instance_id}"
                               policyRef="default"/>
      </bpmn:extensionElements>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="Task_mark_needs_revision"
                      name="Mark requirement Needs Revision">
      <bpmn:documentation>
        Server-side publish validation failed. Requirement remains in Drafting/Needs Revision with evidence attached.
      </bpmn:documentation>
      <bpmn:extensionElements>
        <ameide:taskDefinition type="transformation.r2d.phase1.triage.mark_needs_revision.v1"
                               idempotencyKeyTemplate="r2d/${process_instance_id}/${step_id}/${step_instance_id}"
                               policyRef="default"/>
      </bpmn:extensionElements>
    </bpmn:serviceTask>

    <bpmn:endEvent id="EndEvent_triage_complete" name="Triage complete">
      <bpmn:documentation>
        Terminal of Phase 1.
        On success: Requirement is Ready for Development (slice pinned).
        On failure: Requirement is Needs Revision (no slice pinned).
      </bpmn:documentation>
    </bpmn:endEvent>

    <bpmn:sequenceFlow id="Flow_1" sourceRef="StartEvent_publish_requested" targetRef="Task_validate_publish_preconditions"/>
    <bpmn:sequenceFlow id="Flow_2" sourceRef="Task_validate_publish_preconditions" targetRef="Gateway_publish_ok"/>
    <bpmn:sequenceFlow id="Flow_3_ok" sourceRef="Gateway_publish_ok" targetRef="Task_pin_slice">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">state.publish_ok</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_3_fail" sourceRef="Gateway_publish_ok" targetRef="Task_mark_needs_revision"/>
    <bpmn:sequenceFlow id="Flow_4" sourceRef="Task_pin_slice" targetRef="Task_mark_ready_for_development"/>
    <bpmn:sequenceFlow id="Flow_5" sourceRef="Task_mark_ready_for_development" targetRef="EndEvent_triage_complete"/>
    <bpmn:sequenceFlow id="Flow_6" sourceRef="Task_mark_needs_revision" targetRef="EndEvent_triage_complete"/>
  </bpmn:process>
</bpmn:definitions>
