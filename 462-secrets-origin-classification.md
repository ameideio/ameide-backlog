# 462 – Secrets Origin Classification

**Created:** Dec 2025
**Owner:** Platform DX / Infrastructure
**Cross-references:**
- [418-secrets-strategy-map.md](./418-secrets-strategy-map.md) – Strategy overview and gaps
- [412-cnpg-owned-postgres-greds.md](./412-cnpg-owned-postgres-greds.md) – CNPG credential ownership model
- [451-secrets-management.md](./451-secrets-management.md) – Azure KV → Vault → K8s flow
- [362-unified-secret-guardrails-v2.md](./362-unified-secret-guardrails-v2.md) – Guardrails and bootstrap modes
- [319-onboarding-v3.md](./319-onboarding-v3.md) – Keycloak realm provisioning flow

---

## Principle

**Secrets are classified by their origin, which determines their authoritative source:**

1. **External/Third-Party Secrets** → Azure Key Vault is the authority
2. **Cluster-Managed Secrets** → In-cluster operators/Helm are the authority; Vault may mirror but never drives

This distinction prevents the anti-pattern where cluster-generated secrets (like database passwords or OIDC client secrets) are fetched from an external source that only contains placeholder values.

---

## Classification Matrix

| Category | Examples | Authority | Controller | Flow |
|----------|----------|-----------|------------|------|
| **External/Third-Party** | GHCR tokens, Anthropic API keys, Azure DNS credentials, external OAuth secrets | Azure Key Vault | vault-bootstrap CronJob | `.env` → Terraform → Azure KV → vault-bootstrap → Vault → ExternalSecrets → K8s |
| **Cluster-Managed (Operator-Reconciled)** | Postgres credentials (CNPG), Redis auth | K8s Secret (created by Helm) | CNPG/Redis Operator reconciles DB to match Secret | Helm generates Secret → Operator syncs DB role → (optional) PushSecret → Vault |
| **Cluster-Managed (Helm-Generated)** | MinIO root, Grafana admin, bootstrap secrets | K8s Secret (created by Helm) | Helm `randAlphaNum` + `lookup` | Helm generates on first install → K8s Secret → (optional) PushSecret → Vault |
| **Cluster-Managed (Service-Generated)** | Keycloak client secrets, OIDC tokens | Service (Keycloak, etc.) | client-patcher Job extracts from service API | Service generates → Job extracts via API → Vault → ExternalSecrets → K8s |

---

## Detailed Classification

### 1. External/Third-Party Secrets (Azure KV Authority)

These secrets originate **outside the cluster** and must be provisioned before cluster bootstrap:

| Secret | Purpose | Azure KV Path | Vault Path |
|--------|---------|---------------|------------|
| `ghcr-token` | GitHub Container Registry pull | `ghcr-pull-secret` | `secret/ghcr-pull-secret` |
| `anthropic-api-key` | LLM inference | `anthropic-api-key` | `secret/anthropic-api-key` |
| `openai-api-key` | LLM inference | `openai-api-key` | `secret/openai-api-key` |
| `langsmith-api-key` | Tracing | `langsmith-api-key` | `secret/langsmith-api-key` |
| `azure-dns-*` | cert-manager DNS01 | `azure-dns-*` | `secret/azure-dns-*` |
| `argocd-oidc-secret` | ArgoCD Azure AD SSO | `argocd-oidc-secret` | `secret/argocd-oidc-secret` |

**Bootstrap Flow:**
```
Developer .env → Terraform azurerm_key_vault_secret → Azure KV
                                                        ↓
vault-bootstrap CronJob fetches via Federated Identity → Vault kv/secret
                                                        ↓
ExternalSecrets (ClusterSecretStore: ameide-vault) → K8s Secrets
```

### 2. Cluster-Managed: Operator-Reconciled (CNPG, etc.)

These secrets are **generated by Helm** and **reconciled by Kubernetes operators** to keep the database in sync:

| Secret | Authority | Controller | Pattern | Reference |
|--------|-----------|------------|---------|-----------|
| `postgres-ameide-auth` | K8s Secret (Helm) | CNPG reconciles DB role to match | Helm generates → CNPG syncs to Postgres | [412](./412-cnpg-owned-postgres-greds.md) |
| `keycloak-db-credentials` | K8s Secret (Helm) | CNPG reconciles DB role to match | Same as above | [412](./412-cnpg-owned-postgres-greds.md) |
| `temporal-db-env` | K8s Secret (Helm) | CNPG reconciles DB role to match | Same as above | [412](./412-cnpg-owned-postgres-greds.md) |
| `*-db-credentials` (all services) | K8s Secret (Helm) | CNPG reconciles DB role to match | Same as above | [412](./412-cnpg-owned-postgres-greds.md) |

> **Vendor Note (CloudNativePG):** CNPG does not auto-generate password secrets. You define a `passwordSecret` reference, and CNPG assumes that K8s Secret already exists. CNPG then uses that secret to create/alter the Postgres role and keeps the DB password in sync with it. See [CNPG Declarative Role Management](https://cloudnative-pg.io/documentation/current/declarative_role_management/).

**Pattern (from 412):**
```yaml
# Helm generates password into K8s Secret; CNPG reconciles Postgres role to match
{{- $existingSecret := lookup "v1" "Secret" $namespace $secretName -}}
{{- $password := "" -}}
{{- if $existingSecret -}}
  {{- $password = index $existingSecret.data "password" | b64dec -}}
{{- else -}}
  {{- $password = randAlphaNum 32 -}}
{{- end -}}
```

**Key Principles:**
- **Authority:** The K8s Secret created by Helm owns the password value
- **Controller:** CNPG reconciles the Postgres role to match the Secret (and keeps them in sync)
- **Vault:** Never the authority for DB passwords—only ever a mirror via PushSecret (with `updatePolicy: Replace` so K8s remains source-of-truth)

### 3. Cluster-Managed: Helm-Generated

These secrets are generated by Helm on first install and preserved on upgrades:

| Secret | Purpose | Authority | Chart |
|--------|---------|-----------|-------|
| `minio-root-credentials` | MinIO admin | K8s Secret (Helm-generated) | `foundation-minio` |
| `grafana-admin-credentials` | Grafana admin | K8s Secret (Helm-generated) | `data-grafana` |
| `keycloak-bootstrap-admin` | Keycloak initial admin | K8s Secret (Helm-generated or Operator) | `platform-keycloak` |

> **Vendor Note (Helm):** Helm docs warn that `randAlphaNum` generates new values on every template execution. The `lookup` + default pattern preserves the original value across upgrades. See [Helm Template Functions](https://helm.sh/docs/chart_template_guide/function_list/).

> **Vendor Note (Keycloak Operator):** If using the upstream Keycloak Operator without a custom bootstrap secret, the operator itself generates `<name>-initial-admin` and is the authority for those bootstrap credentials. In that case, treat them as **service-generated** cluster-managed secrets, not Helm-generated. Our current setup pre-creates `keycloak-bootstrap-admin` via Helm, so Helm is the authority.

**Pattern:**
```yaml
# Helm generates once, preserves on upgrade
{{- $existing := lookup "v1" "Secret" .Release.Namespace "my-secret" -}}
{{- $password := $existing | dig "data" "password" "" | b64dec | default (randAlphaNum 32) -}}
```

**Key Principles:**
- **Authority:** K8s Secret created by Helm (not Vault)
- **Mirroring:** These secrets may optionally be mirrored to Vault via PushSecret for observability/backup, but Vault is not the authority
- **Vault fixtures:** The current Vault fixtures (e.g., `grafana-admin-password: "C1tr0n3lla!"`) are **dev/CI conveniences only**—production must use Helm-generated values or environment-specific overrides

### 4. Cluster-Managed: Service-Generated (Keycloak Client Secrets)

**This is the pattern currently missing for `platform-app-master-client`.**

For runtime Keycloak clients, the flow should be:

| Secret | Current State | Target State |
|--------|--------------|--------------|
| `platform-app-master-client` | Vault fixture placeholder | Keycloak-generated → Vault |
| `www-ameide-platform-keycloak-secret` | Vault fixture placeholder | Same secret as above |

> **Vendor Note (Keycloak Admin API):** Keycloak's Admin REST API exposes endpoints for client secret management:
> - `GET /{realm}/clients/{id}/client-secret` – retrieve current secret
> - `POST /{realm}/clients/{id}/client-secret` – regenerate secret
> - `GET/DELETE /{realm}/clients/{id}/client-secret/rotated` – manage rotated secrets
>
> See [Keycloak Admin REST API - Clients](https://www.keycloak.org/docs-api/latest/rest-api/#_clients).

**Target Flow (per 319-onboarding-v3):**
```
Keycloak Operator creates realm with client (Keycloak generates client secret)
    ↓
client-patcher Job extracts client secret via Admin API:
  GET /admin/realms/{realm}/clients/{id}/client-secret
    ↓
Job writes to Vault: secret/platform-app-master-client-secret
    ↓
ExternalSecrets sync to K8s: platform-app-master-client, www-ameide-platform-auth
    ↓
www-ameide-platform reads AUTH_KEYCLOAK_SECRET from K8s Secret
```

**Key Principles:**
- **Authority:** Keycloak is the source-of-truth for client secrets (it generates them)
- **Extraction:** client-patcher Job reads from Keycloak API and publishes to Vault
- **Distribution:** ExternalSecrets sync from Vault to consuming applications
- **Anti-pattern:** Using Vault fixtures as "placeholder" client secrets causes `invalid_client_credentials` errors

**Implemented (2025-12-07):** The `client-patcher` Job extracts client secrets from Keycloak Admin API and writes them to Vault. ExternalSecrets then sync to consuming applications. The flow is fully declarative and reproducible across all environments (dev, staging, production).

---

## Anti-Patterns to Avoid

### 1. Fetching Cluster-Managed Secrets from Azure KV
```
# WRONG: Azure KV has placeholder because secret is cluster-generated
Azure KV (placeholder) → Vault → K8s → App fails with invalid_client_credentials
```

### 2. Vault as Authority for Operator-Managed Resources
```
# WRONG: Vault and CNPG both think they own the password
Vault writes password → ExternalSecret → K8s Secret
CNPG reads Secret → Sets DB role password
(Later) Vault rotates → Secret changes → CNPG reconciles... but what if CNPG already set a different value?
```

### 3. Fixtures in Production
```
# WRONG: Fixture placeholders used as real secrets
Vault fixture: platform_client_secret
Keycloak has different secret → Auth fails
```

---

## PushSecret Semantics (Cluster → Vault Mirroring)

When mirroring cluster-managed secrets to Vault for observability/backup, use External Secrets Operator's `PushSecret` resource:

> **Vendor Note (ESO PushSecret):** PushSecret reads a local K8s Secret and pushes its content into a secret provider. The `updatePolicy` controls which side is source-of-truth:
> - `Replace` (recommended): K8s Secret is source-of-truth; Vault is overwritten on every sync
> - `IfNotExists`: Vault is source-of-truth; only writes if path doesn't exist (causes divergence risk)
>
> See [External Secrets - PushSecret](https://external-secrets.io/latest/guides/pushsecrets/).

**Our Pattern:**
```yaml
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: platform-db-credentials-mirror
spec:
  updatePolicy: Replace  # K8s is source-of-truth, Vault is replica
  secretStoreRefs:
    - name: ameide-vault
      kind: SecretStore
  selector:
    secret:
      name: platform-db-credentials
  data:
    - match:
        secretKey: password
        remoteRef:
          remoteKey: platform-db-password
```

**Key Rules:**
- Always use `updatePolicy: Replace` for cluster-managed → Vault mirroring
- Never combine `ExternalSecret` (Vault → K8s) and `PushSecret` (K8s → Vault) for the same secret path
- PushSecret is for audit/observability only—Vault replica must never be used as source for other ExternalSecrets

---

## Implementation Checklist

### Immediate Fix: Keycloak Client Secrets

- [ ] **462-1**: Update `client-patcher` Job to write extracted client secret to Vault path `secret/platform-app-master-client-secret`
- [ ] **462-2**: Create ExternalSecret `platform-app-master-client-sync` that reads from Vault
- [ ] **462-3**: Update `www-ameide-platform-auth` ExternalSecret to source `AUTH_KEYCLOAK_SECRET` from same Vault path
- [ ] **462-4**: Remove placeholder fixtures for Keycloak client secrets from vault-bootstrap ConfigMap
- [ ] **462-5**: Verify auth flow in dev: `curl /api/auth/signin` succeeds

### Documentation Updates

- [ ] **462-6**: Update 418-secrets-strategy-map.md to reference this classification
- [ ] **462-7**: Update 451-secrets-management.md to clarify Azure KV is for external secrets only
- [ ] **462-8**: Add "Secret Origin" section to service README template

### Future: Secret Origin Validation

- [ ] **462-9**: Add CI check that validates secret classification (external secrets have Azure KV source, cluster secrets don't)
- [ ] **462-10**: Add `secrets-smoke` check that cluster-managed secrets are NOT placeholder values

---

## Decision Log

| Date | Decision | Rationale |
|------|----------|-----------|
| 2025-12-07 | Use static binaries for jq/curl in client-patcher init container | Alpine-compiled binaries fail on Keycloak UBI (glibc/musl mismatch). Static binaries from GitHub releases work across distros. |
| 2025-12-07 | Make vault-bootstrap idempotent (skip real values) | Prevents CronJob from overwriting Keycloak-generated secrets with fixture placeholders on subsequent runs. |
| 2025-12-07 | Align secretExtraction config across all environments | Same client IDs and Vault keys in dev/staging/production ensures reproducibility. Environment-specific Vault addresses only. |
| 2025-12-07 | Keycloak client secrets are cluster-managed, not external | Keycloak generates client secrets; there's no external source. Fixtures are only for dev bootstrapping. |
| 2025-12-05 | CNPG owns all Postgres credentials | Single controller avoids split-brain. See [412](./412-cnpg-owned-postgres-greds.md). |
| 2025-11 | Azure KV for external secrets | Third-party API keys must be provisioned before cluster exists. |

---

## Compliance Audit (2025-12-07)

### Summary

| Category | Compliant | Non-Compliant | Notes |
|----------|-----------|---------------|-------|
| Database Credentials | ✅ 12/12 | 0 | All services use CNPG-owned secrets per [412](./412-cnpg-owned-postgres-greds.md) |
| Keycloak Client Secrets | ✅ 5/5 | 0 | `platform-app`, `platform-app-master` extracted via client-patcher → Vault |
| OIDC Client Secrets | ⚠️ 0/6 | 6 | ArgoCD, K8s Dashboard, Alertmanager, Prometheus, Temporal, PgAdmin |
| External API Keys | ✅ 5/5 | 0 | Proper Azure KV → Vault flow |
| Bootstrap Admin Secrets | ⚠️ Partial | Partial | Fixtures appropriate for dev; production needs real values |

### Compliance Matrix

| Secret | Location | Current Authority | Expected Authority | Status | Severity |
|--------|----------|-------------------|-------------------|--------|----------|
| `platform-app-client-secret` | client-patcher → Vault | Keycloak-generated | Keycloak-generated | ✅ COMPLIANT | - |
| `platform-app-master-client-secret` | client-patcher → Vault | Keycloak-generated | Keycloak-generated | ✅ COMPLIANT | - |
| `AUTH_KEYCLOAK_SECRET` | ExternalSecret ← Vault | Keycloak-generated | Keycloak-generated | ✅ COMPLIANT | - |
| `AUTH_KEYCLOAK_ADMIN_CLIENT_SECRET` | ExternalSecret ← Vault | Keycloak-generated | Keycloak-generated | ✅ COMPLIANT | - |
| `AMEIDE_PLATFORM_APP_SECRET` | [platform-keycloak-realm.yaml](../sources/values/_shared/platform/platform-keycloak-realm.yaml) | `platform-app-master-client` | `platform-app-master-client` | ✅ COMPLIANT | - |
| `www-ameide-keycloak-secret` | [foundation-vault-bootstrap.yaml:167](../sources/values/_shared/foundation/foundation-vault-bootstrap.yaml#L167) | Vault fixture | Keycloak-generated | ❌ NON-COMPLIANT | MEDIUM |
| `argocd-dex-client-secret` | [foundation-vault-bootstrap.yaml:70](../sources/values/_shared/foundation/foundation-vault-bootstrap.yaml#L70) | Vault fixture | Keycloak-generated | ❌ NON-COMPLIANT | MEDIUM |
| `k8s-dashboard-oidc-client-secret` | [foundation-vault-bootstrap.yaml:89](../sources/values/_shared/foundation/foundation-vault-bootstrap.yaml#L89) | Vault fixture | Keycloak-generated | ❌ NON-COMPLIANT | LOW |
| `alertmanager-oidc-client-secret` | [foundation-vault-bootstrap.yaml:65](../sources/values/_shared/foundation/foundation-vault-bootstrap.yaml#L65) | Vault fixture | Keycloak-generated | ❌ NON-COMPLIANT | LOW |
| `prometheus-oidc-client-secret` | [foundation-vault-bootstrap.yaml:148](../sources/values/_shared/foundation/foundation-vault-bootstrap.yaml#L148) | Vault fixture | Keycloak-generated | ❌ NON-COMPLIANT | LOW |
| `temporal-oidc-client-secret` | [foundation-vault-bootstrap.yaml:155](../sources/values/_shared/foundation/foundation-vault-bootstrap.yaml#L155) | Vault fixture | Keycloak-generated | ❌ NON-COMPLIANT | LOW |
| `pgadmin-oidc-client-secret` | [foundation-vault-bootstrap.yaml:126](../sources/values/_shared/foundation/foundation-vault-bootstrap.yaml#L126) | Vault fixture | Keycloak-generated | ❌ NON-COMPLIANT | LOW |
| `keycloak-admin-password` | [foundation-vault-bootstrap.yaml:90](../sources/values/_shared/foundation/foundation-vault-bootstrap.yaml#L90) | Vault fixture | Helm-generated or env-injected | ⚠️ CONDITIONAL | HIGH |
| `keycloak-master-admin-password` | [foundation-vault-bootstrap.yaml:94](../sources/values/_shared/foundation/foundation-vault-bootstrap.yaml#L94) | Vault fixture | Helm-generated or env-injected | ⚠️ CONDITIONAL | HIGH |
| `grafana-admin-password` | [foundation-vault-bootstrap.yaml:75](../sources/values/_shared/foundation/foundation-vault-bootstrap.yaml#L75) | Vault fixture (dev) | Helm-generated (prod), optionally mirrored to Vault | ✅ COMPLIANT (dev) | - |
| `minio-root-password` | [foundation-vault-bootstrap.yaml:110](../sources/values/_shared/foundation/foundation-vault-bootstrap.yaml#L110) | Vault fixture (dev) | Helm-generated (prod), optionally mirrored to Vault | ✅ COMPLIANT (dev) | - |
| `ghcr-token` | Azure KV → Vault | Azure KV | Azure KV | ✅ COMPLIANT | - |
| `anthropic-api-key` | Azure KV → Vault | Azure KV | Azure KV | ✅ COMPLIANT | - |
| `postgres-ameide-auth` | Helm → CNPG reconciles | K8s Secret (Helm) | K8s Secret (Helm), CNPG reconciles DB | ✅ COMPLIANT | - |
| `*-db-credentials` | Helm → CNPG reconciles | K8s Secret (Helm) | K8s Secret (Helm), CNPG reconciles DB | ✅ COMPLIANT | - |

### Critical Findings (RESOLVED 2025-12-07)

> **Status:** All critical findings below have been **RESOLVED** via client-patcher Job implementation.
> See Activity Tracking: 462-1 through 462-5, 462-11 through 462-15, 462-33 through 462-35.

#### 1. ~~Keycloak Client Secret Authority Violation~~ ✅ FIXED

**Was:** `platform-app-master-client` used a hardcoded fixture value.

**Fixed Flow:**
```
Keycloak generates client secret
    ↓
client-patcher Job extracts via Admin API
    ↓
Writes to Vault: secret/platform-app-master-client-secret
    ↓
vault-bootstrap CronJob skips (has real value)
    ↓
ExternalSecret syncs to K8s secret
    ↓
www-ameide-platform uses correct Keycloak-generated secret
```

**Implementation:**
- [client-patcher-job.yaml](../sources/charts/foundation/operators-config/keycloak_realm/templates/client-patcher-job.yaml) - Secret extraction logic
- [vault-bootstrap cronjob.yaml](../sources/charts/foundation/vault-bootstrap/templates/cronjob.yaml) - Idempotent writes
- Per-env config in [dev](../sources/values/dev/platform/platform-keycloak-realm.yaml), [staging](../sources/values/staging/platform/platform-keycloak-realm.yaml), [production](../sources/values/production/platform/platform-keycloak-realm.yaml)

#### 2. ~~www-ameide-platform-keycloak-secret Fixture~~ ✅ FIXED

**Was:** Auth.js received fixture value causing `invalid_client_credentials`.

**Fixed:** `AUTH_KEYCLOAK_SECRET` now sources from `platform-app-client-secret` (Keycloak-generated, extracted by client-patcher).

**Verification (dev):**
```bash
# ExternalSecret syncs Keycloak-generated secret
kubectl get secret -n ameide-dev www-ameide-platform-auth -o jsonpath='{.data.AUTH_KEYCLOAK_SECRET}' | base64 -d
# Returns 22-char secret (not "www_ameide_platform_keycloak_secret")
```

#### 3. ~~AMEIDE_PLATFORM_APP_SECRET Source Mismatch~~ ✅ FIXED

**Was:** Realm import sourced from wrong K8s Secret.

**Fixed:** Now correctly sources from `platform-app-master-client` secret.

#### 4. ~~www-ameide-platform Auth Secret References~~ ✅ FIXED

**Was:** Chart sourced secrets from Vault fixtures.

**Fixed:** Both `AUTH_KEYCLOAK_SECRET` and `AUTH_KEYCLOAK_ADMIN_CLIENT_SECRET` now source from Keycloak-generated secrets via client-patcher → Vault → ExternalSecret flow.

#### 5. OIDC Client Secrets Pattern (ArgoCD, K8s Dashboard, etc.)

**Problem:** Multiple OIDC clients use Vault fixtures instead of Keycloak-generated secrets.

**Affected secrets:**
- `argocd-dex-client-secret` (line 70) - Used by ArgoCD Dex connector
- `k8s-dashboard-oidc-client-secret` (line 89) - Used by K8s Dashboard OAuth2 Proxy
- `alertmanager-oidc-client-secret` (line 65)
- `prometheus-oidc-client-secret` (line 148)
- `temporal-oidc-client-secret` (line 155)
- `pgadmin-oidc-client-secret` (line 126)

**Current Pattern:**
```
Vault fixture → ExternalSecret (keycloak-realm-oidc-clients) → Keycloak realm import
```

**Expected Pattern:**
```
Keycloak generates secret → client-patcher extracts → Vault → ExternalSecret syncs to consumers
```

---

## Remediation Backlog

### Phase 1: Critical - Fix Keycloak Auth Flow (Blocking Production)

#### 462-11: Fix AMEIDE_PLATFORM_APP_SECRET source reference
**File:** `sources/values/_shared/platform/platform-keycloak-realm.yaml` (or per-env overrides)
**Change:**
```yaml
# Before
AMEIDE_PLATFORM_APP_SECRET:
  secret:
    name: www-ameide-platform-auth
    key: AUTH_KEYCLOAK_SECRET

# After
AMEIDE_PLATFORM_APP_SECRET:
  secret:
    name: platform-app-master-client
    key: client-secret
```
**Severity:** CRITICAL
**Status:** [ ] TODO

#### 462-12: Implement Keycloak client secret extraction in client-patcher
**File:** `sources/charts/foundation/operators-config/keycloak_realm/templates/client-patcher-job.yaml`
**Change:** Add script to:
1. Call Keycloak Admin API: `GET /admin/realms/ameide/clients/{id}/client-secret`
2. Write extracted secret to Vault: `vault kv put secret/platform-app-master-client-secret value=$SECRET`
3. Annotate ExternalSecret to force refresh
**Severity:** CRITICAL
**Status:** [ ] TODO

#### 462-13: Remove Keycloak client secret fixtures from vault-bootstrap
**File:** `sources/values/_shared/foundation/foundation-vault-bootstrap.yaml`
**Change:** Remove or comment out:
```yaml
# Line 127 - REMOVE (will be populated by client-patcher)
# platform-app-master-client-secret: "platform_client_secret"

# Line 169 - REMOVE (redundant)
# www-ameide-platform-keycloak-secret: "..."
```
**Severity:** CRITICAL
**Status:** [ ] TODO
**Dependency:** 462-12 must be completed first

#### 462-14: Update www-ameide-platform-auth ExternalSecret
**File:** `sources/values/_shared/apps/www-ameide-platform.yaml`
**Change:**
```yaml
# Ensure AUTH_KEYCLOAK_SECRET sources from the Keycloak-generated secret
remoteKeys:
  AUTH_SECRET: www-ameide-platform-auth-secret
  AUTH_KEYCLOAK_SECRET: platform-app-master-client-secret  # Changed from www-ameide-platform-keycloak-secret
  AUTH_KEYCLOAK_ADMIN_CLIENT_SECRET: platform-app-master-client-secret
```
**Severity:** CRITICAL
**Status:** [ ] TODO

#### 462-15: Verify auth flow end-to-end in dev
**Steps:**
```bash
# 1. Sync keycloak realm
ARGOCD_OPTS="--port-forward --port-forward-namespace argocd" argocd app sync platform-keycloak-realm-dev

# 2. Verify client-patcher ran
kubectl logs -n ameide-dev job/platform-keycloak-realm-client-patcher

# 3. Check Vault has real secret (not fixture)
kubectl exec -n ameide-dev vault-core-dev-0 -- vault kv get secret/platform-app-master-client-secret

# 4. Verify ExternalSecret synced
kubectl get externalsecret -n ameide-dev keycloak-master-platform-app-sync -o yaml

# 5. Test auth flow
curl -s https://platform.dev.ameide.io/api/auth/providers | jq .
```
**Severity:** CRITICAL
**Status:** [ ] TODO

### Phase 2: High Priority - Bootstrap Secret Hardening

#### 462-16: Add fixture warning comments
**File:** `sources/values/_shared/foundation/foundation-vault-bootstrap.yaml`
**Change:** Add header comment:
```yaml
# ==============================================================================
# VAULT BOOTSTRAP FIXTURES - DEVELOPMENT ONLY
# ==============================================================================
# These values are placeholders for local development and CI environments.
# Production environments MUST override these with real secrets via:
# - Azure Key Vault (for external secrets)
# - Environment-specific values files (for bootstrap secrets)
#
# See backlog/462-secrets-origin-classification.md for the full taxonomy.
# ==============================================================================
```
**Severity:** HIGH
**Status:** [ ] TODO

#### 462-17: Create production secret overrides template
**File:** `sources/values/production/foundation/foundation-vault-bootstrap.yaml` (new or update)
**Change:** Create template showing which secrets need real values:
```yaml
# Production overrides - these MUST be real values, not fixtures
fixtures:
  # External secrets - sourced from Azure Key Vault
  # (automatically overwritten by vault-bootstrap from AKV)

  # Cluster-managed secrets - must be injected or generated
  keycloak-admin-password: ""  # REQUIRED: Set via sealed-secret or env injection
  keycloak-master-admin-password: ""  # REQUIRED: Set via sealed-secret or env injection

  # Keycloak client secrets - populated by client-patcher Job
  # DO NOT SET - will be extracted from Keycloak API
  # platform-app-master-client-secret: <generated>
```
**Severity:** HIGH
**Status:** [ ] TODO

#### 462-18: Implement Helm-generated Keycloak admin passwords
**File:** `sources/charts/foundation/operators-config/keycloak_instance/templates/bootstrap-secret.yaml`
**Change:** Use `lookup` + `randAlphaNum` pattern:
```yaml
{{- $existing := lookup "v1" "Secret" .Release.Namespace "keycloak-bootstrap-admin" -}}
{{- $password := $existing | dig "data" "password" "" | b64dec | default (randAlphaNum 32) -}}
```
**Severity:** HIGH
**Status:** [ ] TODO

### Phase 3: Medium Priority - Observability & Validation

#### 462-19: Add secrets-smoke validation for non-placeholder values
**File:** `sources/charts/foundation/secrets-smoke/templates/job.yaml` (or similar)
**Change:** Add check that critical secrets are not placeholder values:
```bash
# Fail if platform-app-master-client-secret is the fixture value
SECRET=$(vault kv get -field=value secret/platform-app-master-client-secret)
if [ "$SECRET" = "platform_client_secret" ]; then
  echo "ERROR: platform-app-master-client-secret is still a fixture value!"
  exit 1
fi
```
**Severity:** MEDIUM
**Status:** [ ] TODO

#### 462-20: Document secret rotation procedures
**File:** `docs/operations/secrets-rotation.md` (new)
**Content:**
- Keycloak client secret rotation via client-patcher
- CNPG database credential rotation
- External API key rotation via Azure KV
**Severity:** MEDIUM
**Status:** [ ] TODO

#### 462-21: Add CI check for fixture values in production values
**File:** `.github/workflows/ci-secrets.yml` (new)
**Change:** Lint production values files for known fixture patterns:
```bash
# Fail if production values contain known fixture values
grep -r "platform_client_secret\|C1tr0n3lla" sources/values/production/ && exit 1
```
**Severity:** MEDIUM
**Status:** [ ] TODO

### Phase 3b: Medium Priority - OIDC Client Secrets Pattern

#### 462-25: Fix ArgoCD client secret authority
**File:** `sources/charts/foundation/operators-config/keycloak_realm/templates/client-patcher-job.yaml`
**Change:** Extend client-patcher to extract ArgoCD client secret:
```bash
# Extract argocd client secret
ARGOCD_SECRET=$(kcadm.sh get clients -r ameide -q clientId=argocd --fields secret | jq -r '.[0].secret')
vault kv put secret/argocd-dex-client-secret value="$ARGOCD_SECRET"
```
**Severity:** MEDIUM
**Status:** [ ] TODO
**Dependency:** 462-12

#### 462-26: Fix K8s Dashboard client secret authority
**File:** Same as 462-25
**Change:** Extract K8s Dashboard client secret via client-patcher
**Severity:** LOW
**Status:** [ ] TODO
**Dependency:** 462-12

#### 462-27: Audit all OIDC client secrets for scope/priority
**Scope:** Determine which OIDC clients need Keycloak-generated secrets vs can remain fixtures:
- `alertmanager-oidc-client-secret` - OAuth2 Proxy (MEDIUM)
- `prometheus-oidc-client-secret` - OAuth2 Proxy (MEDIUM)
- `temporal-oidc-client-secret` - Temporal UI (LOW)
- `pgadmin-oidc-client-secret` - PgAdmin (LOW)
**Output:** Priority matrix for subsequent work items
**Severity:** MEDIUM
**Status:** [ ] TODO

#### 462-28: Fix www-ameide-platform-keycloak-secret (PRIMARY AUTH FIX)
**File:** `sources/values/_shared/apps/www-ameide-platform.yaml`
**Change:** Update ExternalSecret to source `AUTH_KEYCLOAK_SECRET` from Keycloak-generated path:
```yaml
remoteKeys:
  AUTH_SECRET: www-ameide-platform-auth-secret
  AUTH_KEYCLOAK_SECRET: platform-app-master-client-secret  # Changed from www-ameide-platform-keycloak-secret
  AUTH_KEYCLOAK_ADMIN_CLIENT_SECRET: platform-app-master-client-secret
```
**Severity:** CRITICAL
**Status:** [ ] TODO
**Dependency:** 462-12 (client-patcher must populate platform-app-master-client-secret first)

#### 462-29: Verify www-ameide app OIDC auth
**Scope:** Check if `www-ameide` (non-platform) uses Keycloak auth
**File:** `sources/values/_shared/apps/www-ameide.yaml`
**Check:** Does it reference `www-ameide-keycloak-secret`? If yes, needs same fix as 462-28.
**Severity:** MEDIUM
**Status:** [ ] TODO

### Phase 4: Low Priority - Cleanup & Documentation

#### 462-22: Remove redundant www-ameide-platform-keycloak-secret fixture
**File:** `sources/values/_shared/foundation/foundation-vault-bootstrap.yaml`
**Change:** Remove line 169 after 462-28 is complete (secret will be sourced from platform-app-master-client-secret instead)
**Severity:** LOW
**Status:** [ ] TODO
**Dependency:** 462-28

#### 462-23: Update service README templates with secret origin documentation
**Files:** All service chart README.md files
**Change:** Add "Secrets" section documenting:
- Which secrets the service consumes
- Authority for each secret
- Rotation procedure
**Severity:** LOW
**Status:** [ ] TODO

#### 462-24: Archive compliance audit results
**File:** `backlog/462-secrets-origin-classification.md`
**Change:** Update compliance matrix after remediation is complete
**Severity:** LOW
**Status:** [ ] TODO

---

## Documentation Refactoring Map

This section maps all backlog documents that reference secrets and identifies required updates for consistency with this classification.

### Core Secrets Documents (Verified Consistent)

| Document | Status | Notes |
|----------|--------|-------|
| [418-secrets-strategy-map.md](./418-secrets-strategy-map.md) | ✅ **Consistent** | Already references 462 for classification; guiding principle aligns |
| [451-secrets-management.md](./451-secrets-management.md) | ✅ **Consistent** | Scope clearly limited to external/third-party secrets; cross-refs 462 |
| [412-cnpg-owned-postgres-greds.md](./412-cnpg-owned-postgres-greds.md) | ✅ **Consistent** | North star matches "Cluster-Managed: Operator-Owned" pattern; cross-refs 462 |
| [362-unified-secret-guardrails-v2.md](./362-unified-secret-guardrails-v2.md) | ✅ **Consistent** | Already cross-refs 462; dev vs prod bootstrap documented |

### Documents Requiring Updates

| Document | Issue | Required Update | Activity ID |
|----------|-------|-----------------|-------------|
| [333-realms.md](./333-realms.md) | Q6 recommends Azure KV for per-realm client secrets | Update Q6 to recommend Keycloak-generated client secrets (per 462 classification) | 462-30 |
| [323-keycloak-realm-roles.md](./323-keycloak-realm-roles.md) | Sync order mentions `foundation-keycloak-admin-secrets` | Verify alignment with 462 remediation; may need cross-ref | 462-31 |
| [426-keycloak-config-map.md](./426-keycloak-config-map.md) | References secrets strategy but lacks 462 cross-ref | Add cross-reference to 462 for complete picture | 462-32 |

### Documents with Incidental Secret References (No Update Needed)

| Document | Context | Notes |
|----------|---------|-------|
| [460-keycloak-oidc-scopes.md](./460-keycloak-oidc-scopes.md) | `client_secret` in curl example | Example code only; no policy statement |
| [364-argo-configuration.md](./364-argo-configuration.md) | Repo secrets for GitOps | Different domain (GitOps auth vs app secrets) |
| [446-namespace-isolation.md](./446-namespace-isolation.md) | SecretStore/ExternalSecrets in diagram | Architecture diagram; no policy conflict |
| [442-environment-isolation.md](./442-environment-isolation.md) | Per-env secret stores | Aligns with 462 principles |
| [447-third-party-chart-tolerations.md](./447-third-party-chart-tolerations.md) | Tolerations for external-secrets operator | Operator config; no policy conflict |
| [345-ci-cd-unified-playbook.md](./345-ci-cd-unified-playbook.md) | Build-time secrets | Different domain (CI vs runtime) |
| [456-ghcr-mirror.md](./456-ghcr-mirror.md) | Registry pull secrets | External/third-party category (correct) |
| [444-terraform.md](./444-terraform.md) | Azure KV provisioning | External/third-party category (correct) |
| [450-argocd-service-issues-inventory.md](./450-argocd-service-issues-inventory.md) | Various secret issues | Issue tracking; resolved per environment |
| [450-envoy-gateway-per-environment-architecture.md](./450-envoy-gateway-per-environment-architecture.md) | Per-env architecture | Aligns with 462 principles |
| [417-envoy-route-tracking.md](./417-envoy-route-tracking.md) | Routing config | No secrets policy content |
| [423-temporal-argocd-recovery.md](./423-temporal-argocd-recovery.md) | Recovery procedures | Operational doc; follows current patterns |

### Detailed Update Requirements

#### 462-30: Update 333-realms.md Q6 (Client Secrets Management)

**Current (WRONG):**
```markdown
### Q6: Client Secrets Management
**Question:** Where to store per-realm client secrets?
**Recommendation:** Option 2 - Azure Key Vault with naming convention: `realm-{org-slug}-client-secret`
```

**Required Change:**
```markdown
### Q6: Client Secrets Management
**Question:** Where to store per-realm client secrets?

**Recommendation:** Option 3 - Let Keycloak manage, fetch via admin API

Per [462-secrets-origin-classification.md](./462-secrets-origin-classification.md), OIDC client secrets are
**Cluster-Managed (Service-Generated)** secrets. Keycloak generates them; they should NOT be stored in
Azure Key Vault (that's for external/third-party secrets only).

**Flow:**
1. Keycloak generates client secret on client creation
2. `client-patcher` Job extracts secret via Admin API
3. Job writes to Vault (internal store, not Azure KV)
4. ExternalSecrets sync to consuming applications
```

**Severity:** HIGH (incorrect recommendation could cause anti-pattern proliferation)

#### 462-31: Verify 323-keycloak-realm-roles.md sync order

**Current text:**
```markdown
Sync order: `platform-postgres-clusters` (CNPG-managed DB creds) → `foundation-keycloak-admin-secrets`
(bootstrap/admin/client secrets) → `platform-keycloak` → `platform-keycloak-realm`
```

**Required verification:**
- Confirm `foundation-keycloak-admin-secrets` aligns with 462 remediation
- If it sources from Vault fixtures, note dependency on 462-12/462-13

**Severity:** MEDIUM (sync order documentation)

#### 462-32: Add 462 cross-reference to 426-keycloak-config-map.md

**Current:** References 418-secrets-strategy-map but not 462

**Required:** Add to Related section:
```markdown
**Related**: ... · 462-secrets-origin-classification.md
```

**Severity:** LOW (completeness)

---

## Activity Tracking

| ID | Description | Status | Assignee | Date |
|----|-------------|--------|----------|------|
| 462-1 | Update client-patcher Job to write to Vault | ✅ DONE | Claude | 2025-12-07 |
| 462-2 | Create ExternalSecret platform-app-master-client-sync | ✅ DONE | Claude | 2025-12-07 |
| 462-3 | Update www-ameide-platform-auth ExternalSecret | ✅ DONE | Claude | 2025-12-07 |
| 462-4 | Remove fixture for Keycloak client secrets | ⚠️ MODIFIED | Claude | 2025-12-07 |
| 462-5 | Verify auth flow in dev | ✅ DONE | Claude | 2025-12-07 |
| 462-6 | Update 418-secrets-strategy-map.md | ✅ DONE | Claude | 2025-12-07 |
| 462-7 | Update 451-secrets-management.md | ✅ DONE | Claude | 2025-12-07 |
| 462-8 | Add Secret Origin section to README template | TODO | - | - |
| 462-9 | Add CI check for secret classification | TODO | - | - |
| 462-10 | Add secrets-smoke check for placeholder values | TODO | - | - |
| 462-11 | Fix AMEIDE_PLATFORM_APP_SECRET source | ✅ DONE | Claude | 2025-12-07 |
| 462-12 | Implement client secret extraction in client-patcher | ✅ DONE | Claude | 2025-12-07 |
| 462-13 | Remove Keycloak fixture from vault-bootstrap | ⚠️ MODIFIED | Claude | 2025-12-07 |
| 462-14 | Update www-ameide-platform-auth ExternalSecret | ✅ DONE | Claude | 2025-12-07 |
| 462-15 | Verify auth flow end-to-end | ✅ DONE | Claude | 2025-12-07 |
| 462-16 | Add fixture warning comments | ✅ DONE | Claude | 2025-12-07 |
| 462-17 | Create production secret overrides template | TODO | - | - |
| 462-18 | Implement Helm-generated Keycloak admin passwords | TODO | - | - |
| 462-19 | Add secrets-smoke validation | TODO | - | - |
| 462-20 | Document secret rotation procedures | TODO | - | - |
| 462-21 | Add CI check for fixture values | TODO | - | - |
| 462-22 | Remove redundant fixture | ✅ DONE | Claude | 2025-12-07 |
| 462-23 | Update service README templates | TODO | - | - |
| 462-24 | Archive compliance audit results | IN PROGRESS | Claude | 2025-12-07 |
| 462-25 | Fix ArgoCD client secret authority (extend client-patcher) | TODO | - | - |
| 462-26 | Fix K8s Dashboard client secret authority | TODO | - | - |
| 462-27 | Audit all OIDC client secrets for scope/priority | TODO | - | - |
| 462-28 | Fix www-ameide-platform-keycloak-secret (primary auth fix) | ✅ DONE | Claude | 2025-12-07 |
| 462-29 | Verify www-ameide app OIDC auth | TODO | - | - |
| 462-30 | Update 333-realms.md Q6 (Azure KV → Keycloak-generated) | ✅ DONE | Claude | 2025-12-07 |
| 462-31 | Verify 323-keycloak-realm-roles.md sync order alignment | ✅ DONE | Claude | 2025-12-07 |
| 462-32 | Add 462 cross-ref to 426-keycloak-config-map.md | ✅ DONE | Claude | 2025-12-07 |
| 462-33 | Align secretExtraction across all environments | ✅ DONE | Claude | 2025-12-07 |
| 462-34 | Make vault-bootstrap idempotent (skip real values) | ✅ DONE | Claude | 2025-12-07 |
| 462-35 | Use static jq/curl binaries in client-patcher | ✅ DONE | Claude | 2025-12-07 |

---

## References

- [Keycloak Client Secret Extraction](https://www.keycloak.org/docs-api/latest/rest-api/#_clients) – REST API for client secret retrieval
- [ExternalSecrets PushSecret](https://external-secrets.io/latest/api/pushsecret/) – For mirroring cluster secrets to Vault
- [CNPG Managed Roles](https://cloudnative-pg.io/documentation/current/security/) – Operator-managed credentials
